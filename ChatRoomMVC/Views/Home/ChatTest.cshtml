@{
    ViewData["Title"] = "SignalR Chat Test";
}

<h2>SignalR Chat 測試頁</h2>

<label>聊天室 ID：</label>
<input type="number" id="chatRoomId" value="1" />
<br />

<label>身分：</label>
<select id="senderType">
    <option value="Employee">Employee</option>
    <option value="Member">Member</option>
</select>

<label>使用者 ID：</label>
<input type="number" id="senderId" value="1" />

<hr />

<div>
    <input id="messageInput" placeholder="輸入訊息..." />
    <button onclick="sendMessage()">送出</button>
    <button onclick="markAsRead()">標記已讀</button>
</div>

<hr />
<h4>訊息記錄：</h4>
<ul id="messagesList"></ul>

<hr />
<h4>語音通話</h4>
<button onclick="startCall()">📞 發起語音通話</button>
<audio id="remoteAudio" autoplay controls></audio>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        let connection;
        let localStream = null;
        let peer = null;
        let remoteConnectionId = null;

        const messagesList = document.getElementById("messagesList");

        async function setupConnection() {
            const senderId = document.getElementById("senderId").value;
            const senderType = document.getElementById("senderType").value;

            connection = new signalR.HubConnectionBuilder()
                .withUrl(`https://localhost:7265/chathub?userId=${senderId}&userType=${senderType}`)
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveMessage", (msg) => {
                const li = document.createElement("li");
                li.textContent = `[${msg.chatRoomId}] ${msg.senderType}(${msg.senderId}) - ${msg.messageType}: ${msg.content}`;
                messagesList.appendChild(li);
            });

            connection.on("ReceiveCallOffer", async (fromId, offer) => {
                remoteConnectionId = fromId;
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                peer = createPeerConnection();

                localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
                await peer.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peer.createAnswer();
                await peer.setLocalDescription(answer);
                await connection.invoke("SendCallAnswer", fromId, answer);
            });

            connection.on("ReceiveCallAnswer", async (fromId, answer) => {
                await peer.setRemoteDescription(new RTCSessionDescription(answer));
            });

            connection.on("ReceiveIceCandidate", async (fromId, candidate) => {
                await peer.addIceCandidate(new RTCIceCandidate(candidate));
            });

            connection.on("CallRejected", (fromId) => {
                alert("❌ 對方已拒絕通話");
            });

            connection.on("CallEnded", (fromId) => {
                alert("📴 對方已結束通話");
                endCall(false); // 關閉本地通話介面
            });

            await connection.start();
            const roomId = document.getElementById("chatRoomId").value;
            await connection.invoke("JoinGroup", roomId.toString());
        }

        setupConnection();

        function sendMessage() {
            const chatRoomId = parseInt(document.getElementById("chatRoomId").value);
            const senderType = document.getElementById("senderType").value;
            const senderId = parseInt(document.getElementById("senderId").value);
            const messageType = "text";
            const content = document.getElementById("messageInput").value;

            connection.invoke("SendMessage", {
                chatRoomId,
                senderType,
                senderId,
                messageType,
                content
            });
        }

        async function markAsRead() {
            const chatRoomId = parseInt(document.getElementById("chatRoomId").value);
            const senderId = parseInt(document.getElementById("senderId").value);
            const senderType = document.getElementById("senderType").value;

            await fetch("https://localhost:7265/api/messages/mark-as-read", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ chatRoomId, senderId, senderType })
            });

            await connection.invoke("NotifyRead", chatRoomId, senderId, senderType);
            alert("✅ 已標記已讀");
        }

        async function startCall() {
            const senderType = document.getElementById("senderType").value;
            const senderId = parseInt(document.getElementById("senderId").value);
            const targetType = senderType === "Member" ? "Employee" : "Member";
            const targetId = senderType === "Member" ? 1 : 11110;

            const targetConnId = await connection.invoke("GetConnectionId", targetType, targetId);
            if (!targetConnId) {
                alert("⚠️ 找不到對方的連線 ID，可能不在線上");
                return;
            }

            remoteConnectionId = targetConnId;
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            peer = createPeerConnection();

            localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            await connection.invoke("SendCallOffer", targetConnId, offer);
        }

        function createPeerConnection() {
            const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    connection.invoke("SendIceCandidate", remoteConnectionId, e.candidate);
                }
            };

            pc.ontrack = (e) => {
                const audio = document.getElementById("remoteAudio");
                audio.srcObject = e.streams[0];
            };

            return pc;
        }

        async function endCall(sendSignal = true) {
            if (localStream) {
                localStream.getTracks().forEach((t) => t.stop());
                localStream = null;
            }

            if (peer) {
                peer.close();
                peer = null;
            }

            document.getElementById("remoteAudio").srcObject = null;

            if (sendSignal && remoteConnectionId) {
                await connection.invoke("EndCall", remoteConnectionId);
            }
        }

        async function rejectCall() {
            if (remoteConnectionId) {
                await connection.invoke("RejectCall", remoteConnectionId);
                alert("已拒絕通話");
            }
        }
    </script>

}
